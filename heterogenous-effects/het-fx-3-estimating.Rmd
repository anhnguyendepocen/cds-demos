---
title: "Characterizing Effect Heterogeneity 3"
author: "Cyrus Samii"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    includes:
      in_header: preamble.tex
indent: true
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Paths to wd for users
knitr::opts_knit$set(root.dir="~/documents/github/cds-demos/heterogenous-effects")
library(rio)
library(knitr)
library(Emcdf)
library(causalTree)
library(grf)
source("~/documents/github/cds-demos/analysis-functions/analysis-functions.R")
```

\clearpage

```{r, echo=FALSE}
mex_data <- as.data.frame(import("progresa_mat.dta"))
covs <- setdiff(names(mex_data),
                c('indiv_id', 
                  'treatment', 
                  'enrolled', 
                  'treated_adj', 
                  'y_adj',
                  'ml_single_parent',
                  'group'))
mex_data1 <- subset(mex_data, treatment==1)
mex_data0 <- subset(mex_data, treatment==0)
```

# Random Forests

We can proceed in a similar manner as above, looking at models for potential outcomes and then for treatment effects per se. What we want to do is to define variable importance measures for the random forests.  

We work with the "generalized random forest" algorithm of Athey et al.  

## Forests for potential outcomes


```{r}
numTreeVec <- c(2,20, 200, 2000)
for(i in 1:length(numTreeVec) ){
numTrees <- numTreeVec[i]
  mu0_up <- regression_forest(X=mex_data0[,covs],
                         Y=mex_data0[,"enrolled"],
                         num.trees = numTrees,
                         honesty=FALSE,
                         tune.parameters = TRUE,
                         num.fit.trees = numTrees,
                         sample.fraction=.5,
                         min.node.size=2,
                         seed=111)
if(i == 1){mu0      <- list(mu0_up)}
if(i >  1){mu0[[i]] <- mu0_up}
}
```

The variable importance measure that they encode is one that is based on the number of times, across the trees in the forest, that a variable is used to split for different node depths up to some pre-specified depth.  For each variable, the frequency at each node depth is multipled by a depth weight, these weighted frequencies are added up, and then the total is standardized with respect to all of the other variables' sums to give a variable importance measure that sums to 1 across all of the variables.  Here we can see it in action:  

```{r}
# Using the built in function:
cbind(covs,round(variable_importance(mu0[[1]], max.depth=10), 2))
# Code that replicates:
split.freq <- split_frequencies(mu0[[1]], max.depth=10)
split.freq <- split.freq / pmax(1L, rowSums(split.freq))
weight <- seq_len(nrow(split.freq)) ^ -2
var.importance <- t(split.freq) %*% weight / sum(weight)
cbind(covs, round(var.importance, 2))
```

Now we can look at variable importance over the different sized forests:
```{r}

varImpMat <- matrix(NA, ncol=length(covs), nrow=length(numTreeVec))
colnames(varImpMat) <- covs
rownames(varImpMat) <- numTreeVec
for(i in 1:length(numTreeVec)){
  varImpMat[i,] <- variable_importance(mu0[[i]], max.depth=10)
}
varImpAvg <- apply(varImpMat, 2, mean)
varImpMat.or <- varImpMat[, names(varImpAvg)[order(varImpAvg)]]

plot(varImpMat.or[1,], 1:ncol(varImpMat.or), pch=19, cex=.25)
for(i in 2:length(numTreeVec)){
points(varImpMat.or[i,],
       (1:ncol(varImpMat.or))-(i-1)/10,
       pch=19, cex=.25)
}
abline(h=(1:ncol(varImpMat.or))+.5, lty="dashed", col="gray")

```


## Forest for effect heterogeneity




